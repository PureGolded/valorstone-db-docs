{% extends 'base.html' %}
{% set pin = pin %}
{% block content %}
<div class="toolbar">
  <button class="btn primary" data-tooltip="Create a new database design to hold tables and columns" onclick="createDatabase()">+ New Database</button>
  <a class="btn" href="/docs">Open Docs</a>
</div>
<div id="db-list" class="stack"></div>
<div style="margin-top:1rem; display:flex; justify-content:center;">
  <a class="btn primary" style="font-size:1.1rem; padding: .75rem 1.25rem;" href="/docs">â‡¨ Go to Documents</a>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', ()=>{ try { refresh(); } catch(e){ console.error(e); } });

  async function refresh() {
    const res = await fetch('/api/state');
    if (!res.ok) return;
    const state = await res.json();
    renderDbs(state);
  }

  async function createDatabase() {
    const form = Modal.inputs([
      {key:'name', label:'Database Name', type:'text', value:'New Database', help:'A short, descriptive name for this database design.'}
    ]);
    Modal.open({
      title: 'Create Database',
      body: form,
      actions: [
        {label:'Cancel'},
        {label:'Create', className:'primary', onClick: async ()=>{
          const v = form.getValues();
          if (!v.name) return false;
          const res = await fetch('/api/databases', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name: v.name})});
          if (res.ok) await refresh();
        }}
      ]
    });
  }

  async function deleteDatabase(dbId) {
    const body = document.createElement('div');
    body.innerHTML = '<p>Delete this database? This cannot be undone.</p>';
    Modal.open({ title:'Delete Database', body, actions:[ {label:'Cancel'}, {label:'Delete', className:'danger', onClick: async()=>{ const res = await fetch(`/api/databases/${dbId}`, {method: 'DELETE'}); if (res.ok) await refresh(); }} ]});
  }

  function renderDbs(state) {
    const root = document.getElementById('db-list');
    root.innerHTML = '';
    const entries = Object.entries(state);
    if (entries.length === 0) {
      root.innerHTML = '<div class="muted">No databases yet. Create one to start designing.</div>';
      return;
    }
    for (const [id, db] of entries) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="row space-between" style="gap:1rem; align-items:center;">
          <h2 title="A collection of tables and relationships" style="margin:0;">${escapeHtml(db.name)}</h2>
          <div class="row" style="gap: .5rem; flex-wrap: wrap;">
            <button class="btn" title="Create a copy of this database design" onclick="duplicateDb('${id}')">Duplicate</button>
            <a class="btn" title="Open and edit this database" href="/db/${id}">Open</a>
            <button class="btn danger" title="Delete this database design" onclick="deleteDatabase('${id}')">Delete</button>
          </div>
        </div>
        <p class="note">${escapeHtml(db.note || '')}</p>
      `;
      root.appendChild(el);
    }
  }

  async function duplicateDb(dbId) {
    const res = await fetch(`/api/databases/${dbId}/duplicate`, {method: 'POST'});
    if (res.ok) refresh();
  }
</script>
{% endblock %}